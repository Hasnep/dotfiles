#!/usr/bin/env python3

import os
import subprocess
from pathlib import Path

config_directory = os.getenv("XDG_CONFIG_HOME")
if config_directory is None:
    print("Environment variable `XDG_CONFIG_HOME` not set.")
    exit(1)

fish_completions_folder = Path(config_directory) / "fish" / "completions"

for tool, command, output in [
    ("antidot", "antidot completion fish", "prints"),
    ("autorestic", "autorestic completion fish", "prints"),
    ("bin", "bin completion fish", "prints"),
    ("glow", "glow completion fish", "prints"),
    ("just", "just --completions fish", "prints"),
    ("poetry", "poetry completions fish", "prints"),
    ("restic", "restic --fish-completion {completions_file}", "writes"),
    ("trash", "trash completions fish", "prints"),
    ("zellij", "zellij setup --generate-completion fish", "prints"),
]:
    # Check if the tool is installed
    if subprocess.run(f"type {tool}", shell=True, capture_output=True).returncode == 0:
        completions_file = fish_completions_folder / f"{tool}.fish"
        print(f"Generating completions for {tool} in {completions_file}.")
        if output == "writes":
            subprocess.run(
                command.format(completions_file=completions_file),
                shell=True,
                capture_output=True,
                text=True,
            )
        elif output == "prints":
            completions = subprocess.run(
                command, shell=True, capture_output=True, text=True
            ).stdout
            with open(completions_file, "w") as f:
                f.write(completions)
