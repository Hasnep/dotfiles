#!/usr/bin/env python3

import json
import sys
from argparse import ArgumentParser
from enum import Enum
from pathlib import Path
from typing import Dict, List, NamedTuple, Optional, Tuple, Union


class Shell(Enum):
    FISH = "fish"
    POSIX = "posix"


class PathVariable(NamedTuple):
    priority: int
    value: str

    def to_fish(self) -> str:
        return f'fish_add_path --move "{self.value}"'

    def to_posix(self) -> str:
        return f'if [ -d "{self.value}" ] && [[ ":$PATH:" != *":{self.value}:"* ]]; then PATH="${{PATH:+"$PATH:"}}{self.value}"; fi'


class EnvironmentVariable(NamedTuple):
    priority: int
    name: str
    value: str

    def to_fish(self) -> str:
        return f'set --export {self.name} "{self.value}"'

    def to_posix(self) -> str:
        return f'export {self.name}="{self.value}"'


Variable = Union[PathVariable, EnvironmentVariable]


def get_cli_args() -> Tuple[Optional[Path], Optional[Path], Shell]:
    parser = ArgumentParser()
    parser.add_argument(
        "--shell", type=str, choices=[s.value for s in Shell], required=True
    )
    parser.add_argument("input", type=Path, nargs="?")
    parser.add_argument("--output", type=Path, nargs="?")
    args = parser.parse_args()
    input_path: Optional[Path] = args.input
    output_path: Optional[Path] = args.output
    shell = Shell(args.shell)
    return input_path, output_path, shell


def parse_variable(priority: int, name: str, value: str) -> Variable:
    return (
        PathVariable(priority, value)
        if name == "PATH"
        else EnvironmentVariable(priority, name, value)
    )


def get_config(config_file_path: Optional[Path]) -> List[Variable]:
    config: List[Dict[str, str]]
    if config_file_path is None:
        config = json.load(sys.stdin)
    else:
        with open(config_file_path, "r") as f:
            config = json.load(f)
    return [parse_variable(int(x["_priority"]), x["name"], x["value"]) for x in config]


def get_export_script(variables: List[Variable], shell: Shell) -> str:
    return "\n".join(
        variable.to_fish()
        if shell == Shell.FISH
        else variable.to_posix()
        if shell == Shell.POSIX
        else ""
        for variable in variables
    )


def write_script_to_file(script_file_path: Path, script: str) -> None:
    print(f"Writing script to `{script_file_path}`.")
    with open(script_file_path, "w") as f:
        f.write(script)


def main() -> None:
    config_file_path, output_file_path, shell = get_cli_args()
    variables = get_config(config_file_path)
    variables_sorted = sorted(variables, reverse=True)
    export_script = get_export_script(variables_sorted, shell)
    if output_file_path is None:
        print(export_script)
    else:
        write_script_to_file(output_file_path, export_script)


if __name__ == "__main__":
    main()
